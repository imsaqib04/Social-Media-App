{% extends "users/base.html" %}
{% load static %}

{% block body %}
<div class="flex justify-center mt-6">
    <h2 class="text-3xl font-bold text-gray-700">ðŸ“¸ Feed</h2>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mt-8 px-6">
    {% for post in posts %}
    <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition duration-300 max-w-md mx-auto">
        
        <div class="flex items-center gap-3 p-4 border-b">
            <img src="{{ post.user.profile.photo.url }}" 
                 alt="{{ post.user.username }}" 
                 class="w-10 h-10 rounded-full object-cover border">
            <div>
                <h3 class="text-sm font-semibold text-gray-800">{{ post.user.username }}</h3>
                <p class="text-xs text-gray-500">Posted {{ post.created|timesince }} ago</p>
            </div>
        </div>

        <div class="w-full h-[400px]">
            <img src="{{ post.image.url }}" 
                 alt="Post image"
                 class="w-full h-full object-cover">
        </div>

        <div class="px-4 py-3 flex items-center gap-5">
            <img id="{{ post.id }}" class="btn-like w-6 h-6 cursor-pointer hover:scale-110 transition" 
            {% if user in post.liked_by.all %}
                src="{% static 'users/images/love.png' %}" alt="Unlike">
            {% else %}
                src="{% static 'users/images/heart.png' %}" alt="Like">
            {% endif %}

            <img class="w-6 h-6 cursor-pointer hover:scale-110 transition" 
                 src="{% static 'users/images/comment.png' %}" alt="Comment">
            <img class="w-6 h-6 cursor-pointer hover:scale-110 transition" 
                 src="{% static 'users/images/share.png' %}" alt="Share">
        </div>

        <div class="px-4 pb-4">
            <div id="like-text-{{ post.id }}" class="text-sm font-semibold text-gray-700 mb-2">
                {% if post.liked_by.count == 1 %}
                    {{ post.liked_by.first }} likes this
                {% elif post.liked_by.count > 1 %}
                    {{ post.liked_by.first }} and {{ post.liked_by.count|add:"-1" }} others like this
                {% endif %}
            </div>

            <h4 class="text-lg font-medium text-gray-800">{{ post.title }}</h4>
            <p class="text-sm text-gray-600 mt-1">{{ post.caption }}</p>
        </div>
    </div>
    {% empty %}
    <p class="col-span-3 text-center text-gray-500">No posts yet. Be the first to share something!</p>
    {% endfor %}
</div>

<script type="text/javascript">
    const likedIconUrl = "{% static 'users/images/love.png' %}";
    const unlikedIconUrl = "{% static 'users/images/heart.png' %}";

    $(document).ready(function() {
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
            }
        });

        $(document).on('click', '.btn-like', function() {
            var post_id = this.id; 
            var likeButton = $(this);

            $.ajax({
                method: "POST",
                url: '/posts/like', // Make sure this URL is correct
                data: { post_id: post_id }
            })
            .done(function(response) {
                // 1. Update the heart icon
                if (response.liked) {
                    likeButton.attr('src', likedIconUrl);
                } else {
                    likeButton.attr('src', unlikedIconUrl);
                }

                // 2. Update the like text dynamically
                var count = response.likes_count;
                var firstLiker = response.first_liker_username;
                var likeTextElement = $('#like-text-' + post_id);
                var newText = "";

                if (count === 1) {
                    newText = firstLiker + " likes this";
                } else if (count > 1) {
                    var otherLikes = count - 1;
                    newText = firstLiker + " and " + otherLikes + " others like this";
                }

                likeTextElement.text(newText);
            })
            .fail(function() {
                alert("An error occurred. Please try again.");
            });
        });
    });
</script>

{% endblock %}